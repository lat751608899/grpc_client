syntax = "proto3";

//im_group: 即时通信-群
option java_package = "com.cfwf.micro_service.im_group";
package cfwf.micro_service.im_group;

service IM_Group { 
	//获取某用户群列表
	rpc GetGroupList (GetGroupListRequest) returns (GetGroupListResponse) {}

	//获取群成员列表
	rpc GetGroupMembers (GetGroupMembersRequest) returns (GetGroupMembersResponse) {}
	
	//获取群申请列表（未处理的申请）
	rpc GetGroupApplyList (GetGroupApplyListRequest) returns (GetGroupApplyListResponse) {}
	
	//申请加入群
	rpc InsertAskEnterGroup (InsertAskEnterGroupRequest) returns (InsertAskEnterGroupResponse) {}
		
	//处理群申请
	rpc DealGroupApply (DealGroupApplyRequest) returns (CommonResponse) {}
	
	//进入群
	//不用申请，直接加入
	rpc EnterGroup (EnterGroupRequest) returns (CommonResponse) {}
	
	//离开群
	rpc LeaveGroup (LeaveGroupRequest) returns (CommonResponse) {}
    
    //离开所属单位的所有群
	rpc LeaveUnitGroup (LeaveUnitGroupRequest) returns (CommonResponse) {}
	
	//删除群成员
	rpc RemoveGruopMember (RemoveGruopMemberRequest) returns (CommonResponse) {}
	
	//获取群公告/通知列表
	rpc GetGroupInformList (GetGroupInformListRequest) returns (GetGroupInformListResponse) {}
	
	//发布群公告/通知
	rpc InsertGruopInform (InsertGruopInformRequest) returns (InsertGruopInformResponse) {} 
	
	//发送通用计数型消息
	rpc BroadcastCounterMsgToMembers (BroadcastCounterMsgToMembersRequest) returns (CommonResponse) {}

    //发送通用一般消息
	rpc BroadcastCommonMsgToMembers (BroadcastCommonMsgToMembersRequest) returns (CommonResponse) {}
	
	//删除群公告/通知
	rpc DeleteGroupInform (DeleteGroupInformRequest) returns (CommonResponse) {}

	//增加群聊天
	rpc InsertGruopSpeak (InsertGroupSpeakRequest) returns (InsertGruopSpeakResponse) {}
	
	//获取群聊天列表
	rpc GetGroupSpeakList (GetGroupSpeakListRequest) returns (GetGroupSpeakListResponse) {}
	
	//获取群信息
	rpc GetGruopInfo (GetGruopInfoRequest) returns (GetGruopInfoResponse) {}
	
	//创建群
	rpc InsertNewGroup (InsertNewGroupRequest) returns (InsertNewGroupResponse) {}	
	
	//解散群
	rpc DeleteGroup (DeleteGroupRequest) returns (CommonResponse) {}	
	
	//搜索自己所在群群内成员
	rpc  SearchGroupMember (SearchGroupMemberRequest) returns (SearchGroupMemberResponse) {}
	
	//搜索自己所在群
	rpc SearchGroup (SearchGroupRequest) returns (SearchGroupResponse) {}

	
	//设置超级管理员
	rpc SetSuperAdmin(SetSuperAdminRequest) returns (SetSuperAdminRespnse) {}
	
	//设置一般管理员
	rpc SetAdmins(SetAdminsRequest) returns (SetAdminsResponse) {}
	
	//修改群名称
	rpc SetGroupName(SetGroupNameRequest) returns (SetGroupNameResponse) {}
    
    //修改用户在群内的昵称
	rpc SetNickName(SetNickNameRequest) returns (SetNickNameResponse) {}
    
    //修改用户的名字（该名字在用户修改个人信息时设置，用于群用户搜索）
	rpc SetUserName(SetUserNameRequest) returns (SetUserNameResponse) {}
} 

// 通用返回结果
enum RPC_CALL_RESULT {
   RPC_CALL_RESULT_NONE        = 0;   //不应出现
   RPC_CALL_RESULT_SUCCESS     = 1;   //成功
   RPC_CALL_RESULT_DB_ERROR    = 2;   //数据库出错：数据库连接失败、操作失败等
   RPC_CALL_RESULT_INPUT_ERROR = 3;   //传入数据格式错误或不合法
   RPC_CALL_RESULT_ITEM_NOT_EXIST  = 4;   //对应条目不存在，"获取"["删除"/"修改"]单条数据时，若找不到对应数据，则返回该值
   RPC_CALL_RESULT_ITEM_HAS_EXIST  = 5;   //对应条目已存在，"创建"单条数据或批量数据时，若发现已存在相同数据则返回该值； "修改"时，发现除了要修改的对象外，还有其他数据和修改后的数据出现重复时，则不做修改并返回该值
}

//一般rpc调用请求
message CommonRequest{
	string msg = 1;
}

//一般rpc调用返回值
message CommonResponse{
	RPC_CALL_RESULT result = 1;
	string msg = 2;
} 

enum GROUP_TYPE {
	GROUP_TYPE_INIT = 0;                          
	GROUP_TYPE_USER_CREATE = 1;                    //自建群
	GROUP_TYPE_SCHOOL_ALL_TEACHER_STUDENT = 10;     //全校师生群
	GROUP_TYPE_SCHOOL_ALL_TEACHER = 11;             //全校教师群
	GROUP_TYPE_SCHOOL_GRADE_TEACHER = 12;           //年级教师群
	GROUP_TYPE_SCHOOL_CLASS = 13;                   //班级群
	GROUP_TYPE_SCHOOL_TEACHER = 14;                 //校内教师分组
	GROUP_TYPE_SCHOOL_TEAMWORK = 20;                //校内协作组
	GROUP_TYPE_JIAOYAN_TEAMWORK = 21;               //教研协作组
	GROUP_TYPE_EDU_OFFICIAL = 30;                    //教育局群
}

enum GROUP_ENTER_TYPE {
	GROUP_ENTER_TYPE_INIT = 0;
	GROUP_ENTER_TYPE_FREEDOM = 1;     //自由进入 
	GROUP_ENTER_TYPE_APPLY = 2;       //申请进入
	GROUP_ENTER_TYPE_INVITE = 3;      //邀请进入
}

enum GROUP_MEMBER_IDENTITY_TAG {
	IDENTITY_TAG_INIT = 0;
	IDENTITY_TAG_STUDENT = 1;       //自由进入 
	IDENTITY_TAG_TEACHER = 2;       //申请进入
	IDENTITY_TAG_RESEARCHER = 4;    //邀请进入
}

message GroupInfoItem {
	int64 groupid = 1;                //群id
	string name = 2;                  //群名称
	GROUP_TYPE type = 3;              //群类型
	int64 target_unit = 4;            //群所属的单位。 如果是学校内的群，如group_type==全校群，教师群，班级群，校内协作组 等， 则保存 学校id
	int64 target = 5;                 //关联对象id。 
                                      //年级教师群， 保存 (学段[第5位])+(学届[1-4位])，学段:1小学 2初中 3高中;  学届:入学年份;  如 12018，表示小学2018年9月份开学的学届, 22017，表示初中2017年9月份开学的学届 
                                      //班级群， 保存classid; 
                                      //协作组群，保存协作组id
	int64 super_admin = 6;            //超级管理员
	string admins = 7;                //管理员列表:userid,userid...
	string createtime = 8;            //创建时间
	GROUP_ENTER_TYPE enterway = 9;    //自建群进入方式
	int32 member_limit = 10;          //自建群的人数限制 0=不限
	int32 member_count = 11;          //当前成员数
	string target_describe = 12;      //json格式，信息描述，根据fld_type有特定含义。 学校教师群:{"grade_year":2011}  班级群:{"grade_year":2011,"classno":2}
}


//获取群列表
message GetGroupListRequest {
	int64 userid = 1;     //调用者id
    repeated GROUP_TYPE limit_group_type = 2; //可以限定获取的群的类型。不设置表示不限制
}

message GetGroupListResponse {
	RPC_CALL_RESULT result = 1;
	string msg = 2;             //返回信息
	repeated GroupInfoItem list = 3;    //群id列表
}

//获取群成员列表
message GetGroupMembersRequest {
	int64 groupid = 1;    //群ID
    GROUP_MEMBER_IDENTITY_TAG  identity_tag_filter =2; //身份标签筛选
}

message GroupMemberItem {
	int64 userid = 1;         //群成员id
	string nick_name = 2;     //群内备注名称
	string time = 3;          //加入时间
	int64 groupid = 4;        //群id
    uint32 idnetity_tag = 5;  //身份标签, GROUP_MEMBER_IDENTITY_TAG的集合。  如: IDENTITY_TAG_STUDENT，  IDENTITY_TAG_RESEARCHER | IDENTITY_TAG_TEACHER
}

message GetGroupMembersResponse {
	RPC_CALL_RESULT result = 1;
	repeated GroupMemberItem list = 2;
}

//申请加入群
message InsertAskEnterGroupRequest {
	int64 userid = 1;      //申请者id
	int64 groupid = 2;     //群ID
	string content = 3;    //附带信息 
    uint32 idnetity_tag = 4;//身份标签, GROUP_MEMBER_IDENTITY_TAG的集合。  如: IDENTITY_TAG_STUDENT，  IDENTITY_TAG_RESEARCHER | IDENTITY_TAG_TEACHER
}

message InsertAskEnterGroupResponse {
	enum CMD_RESULT{
        kCmdResultNone    = 0;   //服务调用失败 
        kCmdResultSuccess = 1;
        kCmdResultRefuse  = 2;
        kCmdResultWaitApprove = 3;
        kCmdResultError   = 4;
    }
    CMD_RESULT result = 1;
    int64 userid = 2;
    GroupInfoItem group_info = 3;
}

//加入群
message EnterGroupRequest {
	int64 userid = 1;     //用户ID
	int64 groupid = 2;    //群ID  当不知道groupid时，靠3，4,5来确定groupid
	GROUP_TYPE type = 3;              //群类型
	int64 target_unit = 4;            //分组所属的单位，如:学校、教育局 
	int64 target = 5;                 //分组ID, 如 年级编号, 班级id, 协作组id等
    uint32 idnetity_tag = 6;//身份标签, GROUP_MEMBER_IDENTITY_TAG的集合。  如: IDENTITY_TAG_STUDENT，  IDENTITY_TAG_RESEARCHER | IDENTITY_TAG_TEACHER
    bool create_group_if_not_exist = 7; //当groupid==0时，若其他条件完备，但找不到群组时，若本参数为true，则会创建群组
    string create_group_name = 8;    //若创建群有效
    uint32 create_group_orderby = 9; //若创建群有效
    int64 create_super_admin = 10; //若创建群有效
    GROUP_ENTER_TYPE create_enterway = 11; //若创建群有效
    string create_describe = 12;    //若创建群有效
}
              

//离开群
message LeaveGroupRequest {
	int64 userid = 1;     //用户ID
	int64 groupid = 2;    //群ID   当不知道groupid时，靠3，4,5来确定groupid
	GROUP_TYPE type = 3;              //群类型
	int64 target_unit = 4;            //分组所属的单位，如:学校、教育局 
	int64 target = 5;                 //分组ID, 如 年级编号, 班级id, 协作组id等
    bool force_leave = 6; //强制离开，被移出
}

message LeaveUnitGroupRequest {
	int64 userid = 1;     //用户ID
	int64 target_unit = 2;            //所属的单位
    repeated GROUP_TYPE group_type = 3;  //群类型，可多个。 如果设置，则离开所设置的类型的群；如果不设置，则离开此单位所有群
    bool force_leave = 4; //强制离开，被移出
}

//处理群申请
enum DEAL_GROUP_APPLY {
	DEAL_GROUP_APPLY_INIT = 0;
	DEAL_GROUP_APPLY_ACCEPT = 1;   //同意
	DEAL_GROUP_APPLY_REFUSE = 2;   //拒绝
	DEAL_GROUP_APPLY_IGNORE = 3;   //忽略
}

message DealGroupApplyRequest {
	int64 operatorid = 1;        //处理者ID
	int64 msgid = 2;             //群申请的消息id
	int64 groupid = 3;           //群id
	DEAL_GROUP_APPLY result = 4; //处理结果
}

//获取群申请列表
message GetGroupApplyListRequest {
	int64 groupid = 1;     //群ID
}

message GroupApplyItem {
	int64 apply_userid = 1;       //申请者id
	int64 msgid = 2;              //申请消息id
	int64 groupid = 3;            //群id
	string content = 4;           //申请携带的内容
	string time = 5;              //申请时间
}

message GetGroupApplyListResponse {
	RPC_CALL_RESULT result = 1;
	repeated GroupApplyItem list = 2;
}

//删除群成员
message RemoveGruopMemberRequest {
	int64 operatorid = 1;       //处理者id
	int64 memberid = 2;        //被删除人id
	int64 groupid = 3;         //群id
}

//获取群公告列表
message GetGroupInformListRequest {
	int64  groupid = 1;       //群组ID
    int64  before_msgid = 2; //获取发送时间在这个id之前的条目
    int64  after_msgid = 3;  //获取发送时间在这个id之后的条目
    int32 limit_count = 4;   //获取条数
}

message GruopInformItem {
	int64 msgid = 1;                 //消息的id
	int64 userid = 2;                //发布者id
	string content = 3;              //内容
	string attachment_files = 4;     //附件。格式:["fileid":file]
	string attachment_audios = 5;    //语音。格式：["resid":resid]
	string time = 6;                 //发布时间
	int64 groupid = 7;               //群id
}

message GetGroupInformListResponse {
	RPC_CALL_RESULT result = 1;
	repeated GruopInformItem list = 2;
}

//发布群公告
message InsertGruopInformRequest {
	GruopInformItem item = 1;
} 

message InsertGruopInformResponse {
	RPC_CALL_RESULT result = 1;
	string msg = 2;
	int64 msgid = 3; //发布成功后的群公告的id
}

message BroadcastCounterMsgToMembersRequest {
	int64 operatorid = 1;                  //信息发布者id
	int64 send_to_groupid = 2;             //接收信息的groupid
	int64 send_to_targetid = 3;            //classid不知道时，使用targetid 和 send_to_target_type 确定groupid 如果有必要还需加上send_to_target_unit
	int64 send_to_target_unit = 4;         //群组所属单位
	GROUP_TYPE send_to_target_type = 5;    //群组类型
	bytes content = 6;                    // message::CounterMesage序列化后的数据
	GROUP_MEMBER_IDENTITY_TAG sendto_member_tag = 7;    //发送给具有哪种标签的群成员。 IDENTITY_TAG_INIT  表示不限。  
}

message BroadcastCommonMsgToMembersRequest {
	int64 operatorid = 1;                  //信息发布者id
	int64 send_to_groupid = 2;             //接收信息的groupid
	int64 send_to_targetid = 3;            //classid不知道时，使用targetid 和 send_to_target_type 确定groupid 如果有必要还需加上send_to_target_unit
	int64 send_to_target_unit = 4;         //群组所属单位
	GROUP_TYPE send_to_target_type = 5;    //群组类型
	bytes content = 6;                     // message::CommonMesage序列化后的数据
    GROUP_MEMBER_IDENTITY_TAG sendto_member_tag = 7;    //发送给具有哪种标签的群成员。 IDENTITY_TAG_INIT  表示不限。    
}

//删除群公告
message DeleteGroupInformRequest {
	int64 msgid = 1;     //群通知的消息id
	int64 userid = 2;    //操作者id
}

//发送群聊天
enum IM_GROUP_SPEACK_TYPE {
	IM_GROUP_SPEACK_TYPE_INIT = 0;
	IM_GROUP_SPEACK_MIX = 1;          //图文混排
	IM_GROUP_SPEACK_FILE = 2;         //文件  
	IM_GROUP_SPEACK_IMAGE = 3;        //图片
	IM_GROUP_SPEACK_AUDIO = 4;        //语音
	IM_GROUP_SPEACK_LINK = 5;         //超链接
	IM_GROUP_SPEACK_UNDO = 6;         //撤销某条消息
    IM_GROUP_SPEACK_DETAIL = 7;       //详情消息
    IM_GROUP_SPEACK_SYSTEM_INFORM = 8;         //系统通知。
    
}
    
message InsertGroupSpeakRequest {
	int64 userid = 1;                       //发送着userid
	int64 group_id = 2;                     //群id
	IM_GROUP_SPEACK_TYPE speak_type = 3;    //发送的消息类型。如果类型为IM_FRIEND_SPEACK_UNDO，则将要撤销的消息的id放入content字段内
	string content = 4;                     //聊天内容
	bool need_confirm = 5;                  //是否需要接收方做已读确认
    string extra_message = 6;               //附加信息,json格式。 当content ==IM_GROUP_SPEACK_SYSTEM_INFORM 时为:{groupid:xxxx, groupname:xxxx}
}

message InsertGruopSpeakResponse {
	RPC_CALL_RESULT result = 1;
	string msg = 2;
	int64 msgid = 3; //发布成功后的聊天消息的id
}

//获取群聊天列表
message GetGroupSpeakListRequest {	 
    int64  group_id = 1; //群ID
    int64  before_msgid = 2; //获取发送时间在这个id之前的条目
    int64  after_msgid = 3;  //获取发送时间在这个id之后的条目
    int32 limit_count = 4;   //获取条数
}

message GroupChatSpeakInfo {
	int64 userid = 1;                      //发布者id
	int64 groupid = 2;                     //群id
	int64 msgid = 3;                       //消息id
	IM_GROUP_SPEACK_TYPE speak_type = 4;   //聊天类型
	string time = 5;                       //发布时间
	string content = 6;	                   //聊天类容
	bool need_confirm = 7;                 //是否需要已读确认
	int32 confirm_count = 8;               //已确认条数
}

message GetGroupSpeakListResponse {
	RPC_CALL_RESULT result = 1;
	repeated GroupChatSpeakInfo list = 2;
}

//获取群信息
message GetGruopInfoRequest {
	repeated int64 groupid = 1;
}

message GetGruopInfoResponse {
	RPC_CALL_RESULT result = 1;
	repeated GroupInfoItem list = 2;
}

//创建群
message InsertNewGroupRequest {
	int64 userid = 1;          //操作者id
	GroupInfoItem item = 2; 
    int32 orderby = 3; //相同类型的群的获取群列表时的排序号。 学校班级群的该值为: (period * 10000 + grade_year) * 10000 + class_no。 220120001=初中2012届1班
}

message InsertNewGroupResponse {
	RPC_CALL_RESULT result = 1;
	string msg = 2;              //返回信息
	int64 groupid = 3;           //群ID
}

//解散群
message DeleteGroupRequest {
	int64 userid = 1;      //操作者id
	int64 groupid = 2;     //被解散的群ID  当不知道groupid时，靠3，4,5来确定groupid
	GROUP_TYPE type = 3;              //群类型
	int64 target_unit = 4;            //分组所属的单位，如:学校、教育局 
	int64 target = 5;                 //分组ID, 如 年级编号, 班级id, 协作组id等
    bool only_close_group = 6;        //true= 改为“关闭”状态，而不是删除
}

//搜索群内成员
message SearchGroupMemberRequest {
	int64 userid = 1;               //用户id
	repeated string keyword = 2;    //搜索关键字 (群成员用户名、群内备注)
}

message SearchGroupMemberResponse {
	RPC_CALL_RESULT result = 1;
	repeated GroupMemberItem list = 2;
}

//搜索自己所在群
message SearchGroupRequest {
	int64 userid = 1;               //用户id
	repeated string keyword = 2;    //搜索关键字 (群名称)
}

message SearchGroupResponse {
	RPC_CALL_RESULT result = 1;
	repeated GroupInfoItem list = 2;
}


//设置超级管理员
message SetSuperAdminRequest {
	int64 operatorid = 1;          //操作者id 
	int64 super_admin_userid = 2;  //【必填】被设置的超级管理员id
	bool is_add_admin = 3;         //【必填】true:增加管理员权限 false:去掉管理员权限
	int64 group_id = 4;            //群id 使用group_id 或者 type+target_unit+target确定群组，两者不能同时传空
	GROUP_TYPE type = 5;           //群类型
	int64 target_unit = 6;         //分组所属的单位，如:学校、教育局 
	int64 target = 7;              //分组ID, 如 年级编号, 班级id, 协作组id等
}

message SetSuperAdminRespnse {
	RPC_CALL_RESULT result = 1;
	int64 super_admin_userid = 2;  //返回被设置的超级管理员id
	int64 group_id = 3;            //返回群组id
}

//设置一般管理员
message SetAdminsRequest {
	int64 operatorid = 1;              //操作者id 
	repeated int64 admin_userids = 2;  //【必填】被设置的管理员id
	bool is_add_admin = 3;             //【必填】true:增加管理员权限 false:去掉管理员权限
	int64 group_id = 4;                //群id 使用group_id 或者 type+target_unit+target确定群组，两者不能同时传空
	GROUP_TYPE type = 5;               //群类型
	int64 target_unit = 6;             //分组所属的单位，如:学校、教育局 
	int64 target = 7;                  //分组ID, 如 年级编号, 班级id, 协作组id等
}

message SetAdminsResponse {
	RPC_CALL_RESULT result = 1;
	repeated int64 admin_userids = 2;  //返回被设置的管理员id
	int64 group_id = 3;                //返回群组id
}

//修改群名称
message SetGroupNameRequest {
	int64 operatorid = 1;              //操作者id 
	string name = 2;                   //【必填】群名称 
	int64 group_id = 3;                //群id 使用group_id 或者 type+target_unit+target确定群组，两者不能同时传空
	GROUP_TYPE type = 4;               //群类型
	int64 target_unit = 5;             //分组所属的单位，如:学校、教育局 
	int64 target = 6;                  //分组ID, 如 年级编号, 班级id, 协作组id等
}

message SetGroupNameResponse {
	RPC_CALL_RESULT result = 1; 
	int64 group_id = 2;            //返回群组id
}

//修改用户在群内的昵称
message SetNickNameRequest {
	int64 operatorid = 1;              //操作者id 
    int64 userid = 2;                  //设置此人的群内昵称 
    int64 group_id = 3;                //群id 
	string nikename = 4;               //昵称
}

message SetNickNameResponse {
	RPC_CALL_RESULT result = 1; 
}
 
//修改用户的名字（该名字在用户修改个人信息时设置，用于群用户搜索）
message SetUserNameRequest {
	int64 operatorid = 1;              //操作者id 
    int64 userid = 2;                  //设置此人的群内昵称 
    string username = 3;               //昵称
}

message SetUserNameResponse {
	RPC_CALL_RESULT result = 1; 
}



